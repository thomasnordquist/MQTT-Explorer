on:
  pull_request_target: # Use pull_request_target
    branches: [master, beta, release]

jobs:
  test:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/thomasnordquist/mqtt-explorer-ui-tests:latest
      volumes:
        - ./:/app
      options: --user root
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Install Packages
        run: yarn install --frozen-lockfile
      - name: Build
        run: yarn build
      - name: Test
        run: yarn test

  electron-tests:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/thomasnordquist/mqtt-explorer-ui-tests:latest
      volumes:
        - ./:/app
      options: --user root
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Install Packages
        run: yarn install --frozen-lockfile
      - name: Build
        run: yarn build
      - name: Run Electron UI Tests
        timeout-minutes: 10
        run: ./scripts/runUiTests.sh
      - name: Upload Test Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: electron-test-screenshots
          path: |
            test-screenshot-*.png
          retention-days: 30

  demo-video:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/thomasnordquist/mqtt-explorer-ui-tests:latest
      volumes:
        - ./:/app
      options: --user root
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Install Packages
        run: yarn install --frozen-lockfile
      - name: Build
        run: yarn build
      - name: Generate Demo Video
        run: yarn ui-test
      - name: Post-processing
        run: ./scripts/prepareVideo.sh
      - name: Install AWS CLI
        run: |
          apt-get update && apt-get install -y awscli
      - name: Upload to S3 with expiration tag
        id: upload
        env:
          AWS_ACCESS_KEY_ID: ${{ vars.AWS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: 'eu-central-1'
          AWS_BUCKET: ${{ vars.AWS_BUCKET }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # Generate unique filename with PR number and timestamp
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          FILENAME="pr-${PR_NUMBER}-${TIMESTAMP}.gif"

          # Upload file with tagging for lifecycle expiration
          aws s3 cp ./ui-test.gif s3://${AWS_BUCKET}/${FILENAME} \
            --content-type image/gif \
            --tagging "expiration=90days" \
            --acl public-read

          # Generate and save the public URL
          FILE_URL="https://${AWS_BUCKET}.s3.${AWS_DEFAULT_REGION}.amazonaws.com/${FILENAME}"
          echo "file-url=${FILE_URL}" >> $GITHUB_OUTPUT
          echo "Uploaded to: ${FILE_URL}"
      - name: Show URL
        run: echo '${{ steps.upload.outputs.file-url }}'
        id: artifact-upload-step
      - run: echo '<picture><img src="${{ steps.upload.outputs.file-url }}"></picture>' \
          >> $GITHUB_STEP_SUMMARY
      - name: Post video to PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '## ðŸŽ¬ Demo Video Generated\n\n' +
                    '![Demo Video](${{ steps.upload.outputs.file-url }})\n\n' +
                    '_This video will expire in 90 days._'
            });

  test-browser:
    runs-on: ubuntu-latest
    services:
      mosquitto:
        image: eclipse-mosquitto:2
        ports:
          - 1883:1883
        options: >-
          --health-cmd "mosquitto_sub -t '$SYS/#' -C 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
      - name: Install Dependencies
        run: yarn install --frozen-lockfile
      - name: Build Browser Mode
        run: yarn build:server
      - name: Test App
        run: yarn test:app
      - name: Test Backend
        run: yarn test:backend
      - name: Start Server in Background
        run: |
          yarn start:server &
          echo $! > server.pid
        env:
          MQTT_EXPLORER_USERNAME: test
          MQTT_EXPLORER_PASSWORD: test123
          PORT: 3000
      - name: Wait for Server
        run: |
          timeout 30 bash -c 'until curl -f http://localhost:3000; do sleep 1; done'
      - name: Browser Smoke Test
        run: |
          # Test server is running
          curl -f http://localhost:3000 || exit 1
          echo "Browser mode server is running successfully"
      - name: Stop Server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
            rm server.pid
          fi
